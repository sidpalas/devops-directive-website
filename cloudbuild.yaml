# In this directory, run the following command to build this builder.
# $ gcloud --project=devops-directive-project builds submit . --config=cloudbuild.yaml --substitutions COMMIT_SHA=manual,_PROJECT_NAME=devops-directive,_ZONE=us-central1-a,_SSH_STRING=palas@cos-f1-micro

steps:
# Update submodules
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git config -f .git/config submodule."themes/ananke".url https://source.developers.google.com/p/$PROJECT_ID/r/github_sidpalas-gohugo-theme-ananke
    git config -f .gitmodules submodule."themes/ananke".url https://source.developers.google.com/p/$PROJECT_ID/r/github_sidpalas-gohugo-theme-ananke
    git submodule init
    git submodule update
# build hugo site
# See ./hugo-builder/README.md
- name: 'gcr.io/$PROJECT_ID/hugo-builder'
# build the container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/$_PROJECT_NAME-caddy:$COMMIT_SHA', '.']
# push the container image to Container Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/$_PROJECT_NAME-caddy:$COMMIT_SHA']
# cleanup existing containers
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - 'compute'
  - 'ssh'
  - '$_SSH_STRING'
  - '--project'
  - '$PROJECT_ID'
  - '--zone'
  - '$_ZONE'
  - '--'
  - 'docker container stop $$(docker container ls -aq) && docker container rm $$(docker container ls -aq)'
# redeploy with new container
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - 'compute'
  - 'ssh'
  - '$_SSH_STRING'
  - '--project'
  - '$PROJECT_ID'
  - '--zone'
  - '$_ZONE'
  - '--'
  - 'docker run -d --restart=unless-stopped -p 80:80 -p 443:443 -v /home/palas/.caddy:/root/.caddy gcr.io/$PROJECT_ID/devops-directive-caddy:$COMMIT_SHA'
images:
 - 'gcr.io/$PROJECT_ID/$_PROJECT_NAME-caddy:$COMMIT_SHA'



